{% extends "base.html" %}
{% block conteudo %}
<style>
    #friend-list-btn {
        margin: 1rem;
        width: 11rem;
    }

    #container {
        position: absolute;
        width:80%; height:87%;
        top: 13vh; left: 20vw;
        overflow-y:auto;
        background-color: rgb(32, 33, 43);
    }
</style>

<div id="container" class="container-xl">
    {% if session['login_user'] %}
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        Nova Publicação
    </button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="page-wrapper bg-dark p-t-50 p-b-50">
                    <div class="wrapper wrapper--w900">
                        <div class="card card-6">
                            <div class="card-heading">
                                <h2 class="title">Nova Publicação</h2>
                            </div>
                            <div class="card-body">
                                <form action="{{url_for('create_post')}}" method="POST" enctype="multipart/form-data">
                                    <div class="form-row">
                                        <div class="name">Título</div>
                                        <div class="value">
                                            <input class="input--style-6" type="text" name="title" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="name">Descrição</div>
                                        <div class="value">
                                            <div class="input-group">
                                                <textarea class="textarea--style-6" name="description"
                                                    placeholder="Coloque a descrção da sua publicação aqui! ;)"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="name">Digite seu código</div>
                                        <div class="value">
                                            <div class="input-group">
                                                <textarea class="textarea--style-6" name="code"
                                                    placeholder="Cole seu código aqui! ;)"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="name">Arquivos</div>
                                        <div class="value">
                                            <div class="input-group">
                                                <input type="file" name="files[]" id="files" accept=".jpg, .mp4"
                                                    multiple="true">
                                            </div>
                                        </div>
                                    </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn--radius-2 btn--blue-2" type="submit">Enviar Publicação</button>
                            </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="editmodal" tabindex="-1" aria-labelledby="editmodalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editmodalLabel">Atualização do post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{{url_for('edit_post')}}" method="POST">
                        <input type="hidden" id="idpost" name="idpost">
                        <div class="form-row">
                            <div class="name">Título</div>
                            <div class="value">
                                <input class="input--style-6" id="title" type="text" name="title" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="name">Descrição</div>
                            <div class="value">
                                <div class="input-group">
                                    <textarea class="textarea--style-6" id="description" name="description"
                                        placeholder="Coloque a descrção da sua publicação aqui! ;)"></textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </form>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>


    {% endif %}
    <div class="post_list">
    {% if post_list %}
    {% for post in post_list %}
    <div class="post" >
        <div class="user">
            <div class="user_photo">
                <img src="{{ url_for('uploads', filename=post._user.image ) }}" class="rounded-circle" width="64"
                    height="64" alt="...">
            </div>

            <div class="user_name">
                <h3>{{ post._user.name}}</h3>
            </div>
            {% if session['user_id'] == post._user.id %}
            <div class="trash-icon" style="margin-left: 50px;">

                <a href="{{url_for('delete_post', id = post._idPost)}}">
                    <button type="button" class="btn"><img
                            src="{{ url_for('static', filename = 'img/icon/trash.svg') }}" alt=""></button>
                </a>
            </div>
            <!-- Button trigger modal -->
            <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#editmodal"
                data-id="{{ post._idPost}}" data-title="{{post._title}}" data-desc="{{post._description}}">
                <img src="{{ url_for('static', filename = 'img/icon/edit.svg') }}" alt="">
            </button>

            <!-- Modal -->

            {% endif %}
        </div>
        <div class="title">
            <h4 style="color: black;">{{ post._title}}</h4>
        </div>
        <div class="post_desc">
            <a href="{{ url_for('post', id=post._idPost) }}" style="text-decoration: none; color: black;">
                <p>{{ post._description}} </p>
            </a>
        </div>
        <div>
            {% if post._files %}
            <div id="carouselControls{{post._idPost}}" class="carousel carousel-dark slide" data-bs-ride="carousel">
                <div class="carousel-inner">

                    {% if post._files[0]._type == 'video' %}
                    <div class="carousel-item active">
                        <video controls width="100%">
                            <source src="{{ url_for('uploads', filename=post.get_first_file()._filename ) }}"
                                class="rounded mx-auto d-block" width="350" height="350">
                        </video>
                    </div>
                    {% else %}
                    <div class="carousel-item active">
                        <img src="{{ url_for('uploads', filename=post.get_first_file()._filename ) }}"
                            class="rounded mx-auto d-block" width="350" height="350" alt="...">
                    </div>
                    {% endif %}

                    {% for file in post._files %}

                    {% if file._type == 'video' %}
                    <div class="carousel-item">
                        <video controls width="100%">
                            <source src="{{ url_for('uploads', filename=file._filename ) }}"
                                class="rounded mx-auto d-block" width="350" height="350">
                        </video>
                    </div>
                    {% else %}
                    <div class="carousel-item">
                        <img src="{{ url_for('uploads', filename=file._filename ) }}" class="rounded mx-auto d-block"
                            width="350" height="350" alt="...">
                    </div>
                    {% endif %}

                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselControls{{post._idPost}}"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselControls{{post._idPost}}"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            {% endif %}

        </div>
    </div>
    {% endfor %}
    {% else %}

    <h4>Não possui nenhuma postagem para visualizar</h4>
    {% endif %}
    </div>
</div>

{% if session['login_user'] %}
<div class="btn-group dropup" id="friend-list">
    <button type="button" class="btn btn-secondary bottom-right col-1 p-2 position-fixed bottom-0 end-0"
        id="friend-list-btn" data-bs-toggle="dropdown" aria-expanded="false">
        Lista de amigos
    </button>
    <ul class="dropdown-menu" id="user_list_iten">
        <input type="text" id="search_user" name="user" autocomplete="off" placeholder="Procure um usuario">
        <hr>
        {% for friend in friend_list %}
        <li class="line-friend">
            <a class="dropdown-item" href="{{ url_for('user_profile' ,pag='view', id=friend.id) }}">
                <img src="{{ url_for('uploads', filename=friend.image ) }}" alt="" class="rounded-circle" width="32"
                    height="32" alt="..." style="margin: 5px;">
                {{ friend.name }}
            </a>


        </li>
        {% endfor %}
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status" id="loading" hidden>
            </div>
        </div>
    </ul>
</div>
{% endif %}


<script>
    function remove_friendList(list) {
        for (item of list) {
            item.remove()
        }
    }

    async function search_user() {
        let username = document.querySelector('#search_user').value
        const response = await fetch("{{url_for('search_user')}}", {
            method: "POST",
            body: JSON.stringify({
                'user': username
            }),
            headers: {
                "Content-type": "application/json; charset=UTF-8"
            }
        })
        if (response.status == 204)
            return null
        let users_response = await response.json()
        return users_response
    }

    function make_friend_list(user_list) {
        const friend_list = document.querySelector('#user_list_iten')

        user_list.forEach((user) => {
            let li = document.createElement('li')
            li.classList.add('line-friend')
            li.innerHTML += `
                                <a class="dropdown-item" href="/user_profile/${user.id}?pag=view">
                                    <img src="${user.image}" alt="" class="rounded-circle"
                                        width="32" height="32" alt="..." style="margin: 5px;">
                                        ${user.name}
                                </a>
                         `
            friend_list.appendChild(li)
        })

        hiddenspinner()
    }

    function buildspinner() {
        const spinner = document.querySelector('#loading')
        spinner.removeAttribute("hidden")
    }

    function hiddenspinner() {
        let spinner = document.querySelector('#loading')
        spinner.setAttribute("hidden", '')
    }

    document.querySelector('#search_user').addEventListener('keyup', async (event) => {
        ENTER_KEY_ID = 13
        if (event.keyCode == ENTER_KEY_ID) {
            list = document.querySelectorAll('.line-friend')
            remove_friendList(list)
            buildspinner()
            const users_json = await search_user()
            if (users_json)
                make_friend_list(users_json)
            else {
                let li = document.createElement('li')
                li.classList.add('line-friend')
                li.appendChild(document.createTextNode("Usuario não encontrado"))
                document.querySelector("#user_list_iten").appendChild(li)
                hiddenspinner()
            }
        }

    }, 5000)
</script>

{% endblock %}